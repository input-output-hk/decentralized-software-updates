\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[margin=2.5cm]{geometry}

\usepackage{microtype}
\usepackage{mathpazo} % nice fonts
\usepackage{xcolor}
\usepackage[unicode=true,pdftex,pdfa,colorlinks=true]{hyperref}

\begin{document}

\hypersetup{
  pdftitle={Design specification of the Priviledge update mechanism},
  breaklinks=true,
  linkcolor={blue},
  citecolor={blue},
  urlcolor={blue},
  linkbordercolor={white},
  citebordercolor={white},
  urlbordercolor={white}
}

\title{
  Design specification of the Priviledge update mechanism\\
}

\author{
  Nikos Karagiannidis\\
  {\small \texttt{nikos.Karagiannidis@iohk.io}}\\
  \and
  Damian Nadales \\
  {\small \texttt{damian.nadales@iohk.io}}\\
  % TODO: add more authors if deemed appropriate.
}

\date{\today}

\maketitle

\begin{abstract}

\end{abstract}

\tableofcontents
\listoffigures
\listoftables

\section{Purpose}
\label{sec:purpose}

% What is the purpose of this document?
This document presents the design of a decentralized governance mechanism for
updating public blockchain systems.
% What is governance.
In this context, governance refers to the set of rules by which the blockchain
evolves.
% When is governance decentralized?
We say that governance is decentralized when the community can leverage on these
rules to determine the direction in which this blockchain evolves.

% TODO: should we mention here (or somewhere) how governance and the lifecycle of
% an update are related? We also need to define what an update is.

% Why people should care about the problems stated in this document?
A decentralized update mechanism is crucial for achieving a decentralized
blockchain.

% Why people should care about this document? What is the target audience?
This document is intended for stakeholders interested in the implementation of a
decentralized update system for blockchains.

% What does this document contains
This document features a breakdown of the requirements for achieving
decentralization of the update mechanism in a blockchain, and describes a design
that satisfies these requirements.

% Who funded this work?
The work presented here was funded by the PRIViLEDGE project~\cite{priviledge}.

% Scope of this work
The topic of decentralized blockchain governance is difficult and vast.
%
Therefore we identify important problems that were not solved within this
project, but at the same time, we show how the design described here can
accommodate any potential solutions to these problems.

% TODO: mention Voltaire, and how this document relates to it.

\section{Requirements}
\label{sec:requirements}
% FROM: 2 Requirements for a decentralized software update system

This section presents the requirements of an update mechanism for achieving
decentralized governance of a blockchain.

\subsection{Open}
\label{sec:open-participation}

In the absence of malicious actors, we could aspire that anybody who can
participate the blockchain protocol by submitting transactions can participate
in the update process. However allowing this would open the door for spam
attacks: if the barrier for submitting update proposals is as low as submitting
regular transactions, then we risk having a large number of bogus update
proposals being submitted that will overwhelm the human actors that have to
review these proposals.

In light of the risk presented in the preceding paragraph, we require that the
group of people that can participate in the update process should be as broad as
possible, but not broader. This means that:
\begin{itemize}
\item Restrictions on the group of people that can submit update proposals
  should be as loose as possible.
\item Any participant that can submit a common transaction should be able to
  vote on update proposals.
\end{itemize}

\subsection{Democratic}
\label{sec:decentr-decis-making}

All major decisions in the life cycle of a system update should be made by the
community, via a secure voting mechanism.

\subsection{Protocol driven}
\label{sec:protocol-driven}

The update protocol should be an on-chain process, which is automatically
enforced by the ledger rules of the blockchain.

\subsection{Transparent and auditable}
\label{sec:transp-audit}

Anybody should be able to answer \emph{when}, \emph{why}, and \emph{how} the
system has evolved the way it has. The systems' update history should be:
\begin{itemize}
\item open to everyone, and
\item stored in a tamper-free global ledger.
\end{itemize}

\subsection{Secure}
\label{sec:secure}

% TODO: what about other security aspects such as: preservation of ownership,
% resiliency to DoS attacks, replay protection, ensuring participation of an
% honest majority of stake-holders, ensuring liveness, etc.

\subsection{Performant and scalable}
\label{sec:performant-scalable}

The update protocol should have minimal impact on the:
\begin{itemize}
\item transaction throughput,
\item blockchain size, and
\item block processing time.
\end{itemize}
In addition, the impact the update protocol on the metrics above should be a
linear function of the number of participants.

\subsection{Metadata-driven}
\label{sec:metadata-driven}

Not all updates are the same. For instance some updates might be more urgent
than others, some updates might depend on a specific protocol version, some
updates might take longer than others, etc. Therefore, it should be possible to
specify proposal dependent features that the protocol must enforce.

\subsection{Consistent}
\label{sec:cons-update-logic}

The update protocol should define and automatically enforce a policy that is
consistent with the metadata of the update proposals. So for instance, the
update protocol should obey the priorities of proposals.

\section{Design}
\label{sec:design}

% Hmmm, I'm thinking if we need to say something about the blockchain
% architecture we assume: for instance, we assume that we have a ledger
% components that will execute the update protocol somehow.

% Updates are activated.

% Maybe say that we assume the blockchain time is split into epochs.

\subsection{Update types}
\label{sec:update-types}

% What is an update? How are updates related to the blockchain evolution and/or
% how are they related to governance.
Updates are the means by which the blockchain system and related ecosystem (e.g.
wallets, explorers) can evolve. We distinguish the following update types:
\begin{description}
\item[Protocol] These updates affect the consensus rules by which nodes agree on
  a common blockchain. Protocol updates fall in one of the following two
  categories:
  \begin{description}
  \item[Signaled] An update is said to be \emph{signaled} if the nodes must
    signal they readiness to run the new protocol. For instance, when a new
    protocol requires the nodes to download and install new software, the
    protocol must have a way to determine when a sufficient majority of them
    have upgraded to the new version.
    % NOTE: might want to call these software and parameters protocol updates,
    % however this seems to be too specific to the protocol. What happens if in
    % the future we add the ability to upgrade the ledger rules dynamically?
  \item[Non-signaled] An update is said to be \emph{non-signaled} if the nodes
    can move to the new protocol version without needing to know if other nodes
    are ready to move to said version as well. In this kind of updates we assume
    the nodes are already running a version of the software that can switch to
    the new protocol. An example of non-signaled protocol updates is a
    \emph{parameters-update}. In a parameters-update, the nodes have already the
    logic for handling the parameters, and only the values of these parameters
    change after an update is activated.
  \end{description}
\item[Non-protocol] These updates do not affect the consensus rules. The current
  design does not restrict the nature of these updates. It is up to the ledger
  layer to react to these updates accordingly. They might include:
  \begin{itemize}
  \item updates to the software that runs on the blockchain nodes, which does
    not affect the protocol. Examples of such updates might include performance
    or usability improvements.
  \item transfer of funds. For instance an update proposal might involve funding
    the development of a certain feature.
  \item updates to other components of the blockchain ecosystem.
  \end{itemize}
\end{description}

Note that, according to the preceding definition, an update that requires the
node to download and install new software to run a \emph{new protocol}, and that
\emph{also} updates protocol parameters is considered a signaled protocol
update.

% TODO: mention somewhere that protocol updates must be activated one at a time,
% whereas non-protocol updates can be approved in parallel.

% TODO: later on we describe the delegation and voting payload. Maybe we need to
% describe the update payload as well.

\subsection{The lifecycle of a decentralized update}
\label{sec:phases-an-update}
% FROM 3 The lifecycle of a decentralized software update

The update protocol described in this document aims at capturing the whole life
cycle of an update.
%
% TODO: why do we need to have a governance system that captures the whole life cycle
% of an update? So for instance, why not supporting update activations only?
%
% Why distinguish phases at all? SIP and implementations can all be proposals.
% They only differ in that some kinds of approved implementations can be
% activated.
We distinguish the following \emph{phases} in the life cycle of an update:

\begin{description}
\item[Ideation] In this phase, the idea for an update is presented to the
  stakeholders in the form of an \emph{system improvement proposal} (SIP). An
  SIP is voted by the system's stakeholders. An SIP is materialized in the form
  of text document, and as such, once it is approved it does not have any effect
  in the system until its implementation gets activated.
\item[Implementation] In case an update requires an implementation, this is the
  phase where that happens. Some updates like parameter updates, or fund
  transfers do not require an implementation. This phase is not captured by the
  protocol proposed in this document, and we assume it takes place entirely off
  chain.
\item[Approval] In this phase, the information about the implementation of an
  SIP is submitted to the chain. If the implementation refers to a protocol
  update, then the update proposal must contain enough information for the
  protocol to activate it. As in the ideation phase, the stakeholders vote on
  the implementation.
\item[Activation] Once an protocol update implementation is approved, it moves
  to the activation phase, where it might become the current protocol version,
  according to the rules described in Section~\ref{sec:activation}. Non-protocol
  updates are not activated. Their approval is registered by the protocol and
  it is up to the ledger layer to act on them.
\end{description}

In Sections~\ref{sec:ideation} and \ref{sec:approval} we describe the
information that update proposals must submit to the blockchain. Stakeholders
vote on SIPs and their implementations, and thus we describe the voting
mechanism in Section~\ref{sec:voting}. Stakeholders can delegate their vote. The
delegation mechanism and the problems it addresses are described in
Section~\ref{sec:delegation}.

Once an implementation is approved, if it refers to protocol changes it has to
be \emph{activated}. In Section~\ref{sec:activation} we describe the activation
protocol.

When designing a decentralized update protocol for PoS blockchain systems, we
must determine a stake \emph{threshold} to reach on verdict on whether a
proposal should be approved or rejected. This problem is described and addressed
in Section~\ref{sec:threshold-analysis}.

Finally, the update protocol should not have impact on the normal operation of
the blockchain it runs on. In Section~\ref{sec:performance-analysis} we turn our
attention to the performance analysis the protocol described in this document.

% TODO: does this fit anywhere.
%   \begin{itemize}
%   \item software updates (affecting the protocol or otherwise) might contain the
%     location of the source code or binaries of the new protocol, as well as
%     checksum for these artifacts.
%   \item protocol parameter updates, might include the new values of the updated
%     parameters.
%   \item for fund transfers might contain the sources and destinations of funds.
%   \end{itemize}
%   The update protocol does not care about the information that these updates
%   contain. It is up to the particular implementation to choose the appropriate
%   payload, and up to the human reviewers to determine if the information
%   contained in the update proposal payload is sufficient.

\subsection{Delegation}
\label{sec:delegation}

% When we describe how votes are counted we need to talk about delegation. Hence
% we must first talk about what delegation is.
In the proof-of-stake blockchain system we assume in the current design, each
stakeholder has the right to participate in the update protocol.
%
In this section, we discuss the delegation of the voting rights. As we will see
next, this delegation serves various purposes and copes with several practical
challenges.

%%
%% Delegation protocol
%%
\subsubsection{Delegation for technical expertise}
\label{sec:deleg-techn-expert}

One of the first practical challenges in decentralized governance of blockchains
is the requirement of having participants with the sufficient \emph{technical
  expertise} to assess a specific software update proposal.
%
Even at the SIP level, many of the software update proposals are too technical
for the majority of stake to understand.
%
Moreover, during the UP approval phase, the approver is called for approving or
rejecting the submitted source code, which is certainly a task only for experts.

Our proposal for a solution to this problem is to enable delegation to
participants that posses the required technical expertise.
%
Stakeholders will be able to delegate their right to participate in the update
protocol to an \emph{expert pool}. The proposed delegation to an expert pool
comprises the following distinct responsibilities:
\begin{itemize}
\item Voting for a specific SIP.
\item Voting for a given category of SIPs.
\item Voting for any SIP.
\item Approving a specific UP.
\item Approving a given category of UPs.
\item Approving any UP.
\end{itemize}
We distinguish delegation for voting for a SIP document and for approving an UP.
We could have defined delegation for SIP voting to imply also the approval of
the corresponding UP. However, since both have a totally different scope, there
might be a need to delegate to different expert pools to vote on them. An SIP is
an update proposal justification document and the expert who is called to vote
for or against a specific SIP, must have a good sense of the road-map of the
system. On the contrary, the approval of a UP is a very technical task, which
deals with the review and testing of a piece of code against some declared
requirements (i.e. the corresponding SIP) and has nothing to do with the
software road-map.

\subsubsection{Delegation for specialization}
\label{sec:deleg-spec}

There are special categories of software updates, like security fixes.

Common sense dictates that security fixes are software updates which:
\begin{enumerate}
\item have a high priority, and
\item require significant technical expertise to be evaluated.
\end{enumerate}
Therefore, having a special expert pool as a \emph{default delegate} for this
category of software updates (both SIPs and UPs) enables:
\begin{enumerate}
\item faster path to activation, and
\item experts' availability for the evaluation of such updates.
\end{enumerate}
A faster path to activation is achieved because:
\begin{itemize}
\item the delegation step is omitted, and
\item the evaluation (and subsequent vote) will take place generally in shorter
  times, since the proposal is will be evaluated by specialized expert pools that
  deal only with security fixes, so we assume they can do it faster than anybody
  else.
\end{itemize}

We do not propose any specific set of categories in this specification. However,
we do propose that:
\begin{itemize}
\item software updates are tagged with a specific category, and
\item delegation is used to enable specialized treatment on special categories.
\end{itemize}
In particular, for software updates with a special tag, we propose the
consolidation of \emph{default} specialized expert pools that will participate
in the software updates protocol on behalf of the delegated stake.
%
This default delegation based on SU tagging can be overridden. Any stakeholder
can submit a different delegation for a specific SIP/UP regardless of its tag.

\subsubsection{Default delegation for availability}
\label{sec:defa-deleg-avail}

Blockchain protocols based on the Proof-of-Stake (PoS) paradigm are by nature
dependent on the active participation of the digital assets'
owners~\cite{stakepools}, i.e. stakeholders.
%
In practice, we cannot expect stakeholders to continuously participate actively
in the software updates protocol.
%
Some users might lack the expertise to do so, or might not have enough stake to
keep their node up-and-running and connected to the network.

One option to overcome this problem, which is typical in PoS protocols, is to
enable stake representation, thus allowing users to delegate their participation
rights to other participants and, in the process, to form \emph{stake
  pools}~\cite{stakepools}. The core idea is that stake pool operators are
always online and perform the required actions on behalf of regular users, while
the users retain the ownership of their assets (\cite{stakepools}).

In this specification, we propose to utilize the stake pools mechanism for our
software updates protocol in tandem with the consensus protocol. In particular,
we propose to allow each stakeholder to define a default delegate for
participating in the software updates protocol from the list of available stake
pools that participate in the core consensus protocol.
%
This will be a \emph{baseline} representative of each stakeholder to the
software updates protocol, just for the sake of maintaining the participation to
the protocol at a sufficient level and minimizing the risks of
non-participation. This delegate will coincide with the delegate for the
participation in the consensus protocol. A stakeholder will be able at any time
to override this default delegation. A delegation to an expert pool for a
specific software update, or a specific category of software updates, due to
specialization, described in the previous section, will override the default
delegation to a stake pool.

\subsection{Delegation mechanics}
\label{sec:delegation-mechanics}

For the realization of the stake pool delegation mechanism that we described
above, we closely follow the work of Karakostas et al.~\cite{stakepools}, so we
refer the interested reader to this work for all the relevant details.
%
In this subsection, we would like to focus on the most basic mechanics (i.e.
technical details) that will enable such a delegation mechanism to work. Please
note that many of our ideas are based on the design of the delegation mechanism
for the Cardano blockchain system~\cite{deldesign}.

\subsubsection{Staking keys}
\label{sec:staking-keys}

Following the Karakostas et. al.~\cite{stakepools} approach, we separate for
each address the control over the movement of funds (i.e., executing common
transactions, such as payments) and that over the right for participation in the
proof-of-stake protocol and consequently, in the software updates protocol, due
to the ownership of stake.
%
Intuitively, this separation of control is necessary, since we only want to
delegate the management of stake to some other party, by means of participation
in the software updates protocol and not the management of the funds owned by
this stake. This is achieved in practice by assuming that each address consists
of two pair of keys: a) a \emph{payment key pair} $K^p = (skp,vkp)$ and b) a
\emph{staking key pair} $K^s = (sks, vks)$. With the former a stakeholder can
receive and send payments, while with the latter a stakeholder can participate
in the proof-of-stake consensus protocol and in the software updates protocol.
$skp$ and $sks$ are the secret keys for signing, while $vkp$ and $vks$ are the
public keys used to verify signatures.

\subsubsection{Stake delegation}
\label{sec:stake-delegation}

In its simplest form, stake delegation for participation in the proof-of-stake
consensus protocol, also delegates the right for participation in the software
updates protocol.
%
The rationale of this has been described in Section~\ref{sec:defa-deleg-avail}
and it holds only on the assumption that there is no explicit delegation to some
expert pool.
%
So in the rest of this text, when we refer to stake delegation, we mean
for the participation in both the proof-of-stake consensus protocol and the
software updates protocol, unless an explicit statement is made for delegation
to an experts pool.

At its core, the delegation of stake to some other party, essentially requires
two things: a) stake registration and b) issuance of a delegation certificate:

\paragraph{Stake key registration.}
This step is a public declaration of a party that it wishes to exercise its
right for participation in the proof-of-stake protocol, due to its ownership of
stake. In order for a stakeholder to exercise these rights, he/she must first
issue a stake key registration certificate. This is a signed message stored in
the metadata (i.e. payload) of a transaction and thus it is published to the
blockchain. The key registration certificate must contain the public staking key
$vks$, and the signature of the text of the transaction $m$ by the staking
private key $sks$, which is the rightful owner of the stake. In other words, the
key registration certificate $r$ is the pair: $r = (vks, \sigma_{sks}(m))$. The
signature $\sigma$ of the certificate, authorizes the registration and plays the
role of a witness.
%
Symmetrically, there is also a de-registration certificate for a stake key,
which is a declaration that a party no longer wishes to participate in the
proof-of-stake protocol.

\paragraph{Delegation registration.}
In order to register the delegation of stake from one party (source) to another
(target), a delegation certificate must be issued and posted to the blockchain
by the source party. This certificate publicly announces to the network that the
source party wishes to delegate its stake right (for participation in the
proof-of-stake protocol) to the target party and this is recorded forever in the
immutable history of the blockchain. At a minimum, a delegation certificate
consists of the following information:
$$
(H(vks_{source}), H(vks_{target}), \sigma_{sks_{source}}(m))
$$
Where, $H(vks_{source})$ is the hash of the source party's public staking key,
$H(vks_{target})$ is the hash of the target party's public staking key and
$\sigma_{sks_{source}}(m)$ is the signature of the text $m$ of the transaction
(within which the delegation certificate is embedded) by the source party's
private staking key $sks_{source}$, which authorizes the certificate and plays
the role of a witness.

If at some point, the source party wishes to re-delegate to some other party, or
even to participate in the protocol on its own, then it must simply issue a new
delegation certificate. For self-participation in the protocol, a party must
issue a delegation certificate to its own \emph{private stake pool}\footnote{A
  \emph{private stake pool} is a trivial case of a stake pool. By treating
  self-staking as a special case of stake pool delegation is a design decision
  for the sake of simplicity \cite{deldesign}.}. If the source staking key is
de-registered, then the delegation certificate is revoked.

\subsubsection{Delegation to an expert pool}
\label{sec:delegation-an-expert}

We have seen that by default, when somebody delegates her stake for
participation in the PoS protocol to a given pool, she also delegates her
participation rights in the software updates protocol to the same pool.
%
So by default, stake pools will participate in the software updates protocol.
Next, we will discuss the case where a stakeholder wants to override the default
behavior and explicitly delegate to an expert pool.

An expert pool is an entity consisting of one or more experts, who are willing
to participate in the software updates protocol as delegates of other
stakeholders. Their main task is to vote for (or against) SIPs and to approve
(or reject) UPs. We call them \emph{experts} because they need to have
sufficient technical expertise to evaluate software updates.

To enable delegation to an expert pool, we extend the delegation certificate
presented above, with additional information. In particular, a delegation
certificate to an expert pool is defined as the following tuple:

$$
(H(vks_{source}),
 H(vks_{target}),
 \sigma_{sks_{source}}(m),
 SU_{Flag},
 H(<SIP/UP>),
 <category>)
$$

In this case, the $H(vks_{target})$ is the hash of the public staking key of the
expert pool. We have extended the delegation certificate to include a boolean
flag $SU_{Flag}$, which denotes, if the delegation pertains to a SIP, or an UP.
In Section~\ref{sec:deleg-techn-expert} we explained the rationale
for distinguishing the delegation for these two. Finally, the hash $H(<SIP/UP>)$
is the hash of the content of the SIP, or UP, in question and plays the role of
the unique id for this SIP, or UP respectively. Note that if instead of a
specific SIP/UP id, a special value is provided for this field (e.g., '*'), then
this corresponds to a delegation for \emph{any} SU of this type (SIP or UP).
Finally, if the SU id field is empty (or $NULL$, it depends on the
implementation), then we take into account the last field, which specifies the
\emph{category} of the SU (e.g., ``security-fix'', ``linux-update'', etc.)
that we wish to delegate for. This will be a simple string value chosen from a
fixed set of values (a list of acknowledged SU categories).

In summary, with this certificate, a party can delegate its participation right
in the software updates protocol to an expert pool: a) for a specific software
update (SIP or UP), b) for a specific category of software updates, or c) for
any software update. Of course, in order for this delegation registration to be
valid, the target expert pool must have been appropriately registered first in
the blockchain. This topic is discussed next.

\subsubsection{Expert pool registration}
\label{sec:expert-pool-registr}

To run an expert pool, two things are required:
\begin{enumerate}
\item issue an expert pool registration certificate, and
\item provide appropriate \emph{metadata} describing the expert pool.
\end{enumerate}

\paragraph{Expert pool registration certificate.}
This certificate contains the following information:
\begin{itemize}
\item The public staking key of the expert pool: $vks_{expool}$. This must be
  used as the target public key in the delegation certificate, as discussed in
  the previous subsection.
\item A URL pointing to the metadata describing the expert pool and a content
  hash of these metadata: $(<URL>, H(<metadata>))$. The URL points to some
  storage server, and the hash of the content retrieved must match the one
  stored in the certificate for the pool registration to be considered as valid.
\item Signature of the expert pool: $\sigma_{sks_{expool}}(m)$. The certificate
  must be authorized by the signature $\sigma$ of the expert pool $sks_{expool}$
  on the text $m$ of the transaction that includes the certificate.
\end{itemize}

Symmetrically, there should be also an \emph{expert pool retirement certificate}
for allowing an expert pool to cease to operate. This should include the public
staking key of the expert pool, as well as a time indication (e.g., expressed in
block number, or an epoch number etc.) of when the pool will cease to operate.

\paragraph{Expert pool metadata.}
The expert pool metadata are necessary information that sufficiently describe an
expert pool, so that the stakeholders community can decide which expert pool to
choose for their delegations.
%
Typically, this information will be displayed by a wallet application, to assist
the users to select the expert pool of their choice. Examples of useful
information to be included in the expert pool metadata are the name of the pool,
a short description about it, the area of expertise, the years active,
preferences to specific SU categories, URLs to sites that exhibit the claimed
experience, and any information that can help the stakeholders to choose the
appropriate delegate for the right software update.

\subsubsection{Miscellaneous consideration on delegation}
\label{sec:misc-cons-deleg}

\paragraph{Chain delegation.}
Chain delegation is the notion of having multiple certificates chained together,
so that the source key of one certificate is the delegate key of the previous
one. In principle there is no reason to prevent the formation of delegation
chains. However, an implementation of this proposal must take into account the
possibility to form (deliberately or by accident) delegation cycles. This means
that a target delegate ends up to be one of the sources. In this case, the
delegation is essentially canceled and the system should detect it and prevent
it proactively.

\paragraph{Certificate replay attacks.}
For all our certificates, namely: stake key registration, delegation
registration and expert pool registration, we have provided signatures of the
text of the encompassing transaction (the certificates are included as
transaction metadata), signed by the party(ies) authorized to issue the
certificate. This is a design choice made in \cite{deldesign} that prevents
against a certificate replay attack. In this attack, an attacker re-publishes an
old certificate, in order for example to change a delegation to a new expert
pool. In particular, since the certificate includes a signature on a specific
transaction text, then this certificate is bound forever with the specific
transaction, and just like in blockchains with a UTxO accounting model, a
transaction cannot be replayed (a UTxO can be only spent once), similarly the
specific certificate cannot be replayed either. For account based blockchains
there are other approaches that one can follow, in order to prevent a replay
attack, such as the \emph{address whitelist} proposed in Karakostas et. al.
\cite{stakepools}, where the transaction that includes the certificate must be
issued from a specific whitelisted address. Of course there are other common
solutions like the counter-based mechanism (known as the \emph{nonce}) used in
Ethereum \cite{ethereum}.

\paragraph{Identity theft.}
Expertise on difficult technical issues is hard to acquire.
%
Experience comes after a long period (probably many years) of struggle with
technical issues.
%
Therefore, real specialists on a technical domain are hard to find. For this
reason they are invaluable.

Typically, experts are well-known and well-respected figures in the community.
As a result, such a well-known expert is expected to receive a significant
amount of delegations, if she chooses to register an expert pool.
%
This makes expert pool registration susceptible to identity theft. This is the
case where an expert pool falsely claims to be a famous expert, just for the
sake of receiving the delegations from people drawn to the expert's fame.
%
This identity assurance problem is external to the software updates protocol,
and also to the underlying consensus protocol. Thus an out-of-band solution
could be adopted. For example, a renowned expert, could post her public key (or
its fingerprint) to social media, so that the people who follow her will know
which is the genuine key that they can delegate to. Other similar solutions can
be exploited as well. However at the end of the day, in a decentralized setting,
it is the stake, via delegation, that will be the ultimate judge of an expert
pool.

\subsection{Voting}
\label{sec:voting}

% Describe how votes are counted.

\subsection{Threshold analysis}
\label{sec:threshold-analysis}
% FROM 6 Threshold analysis

\subsection{Ideation}
\label{sec:ideation}

The primary goal of the SIP is to capture the idea behind an update.
An SIP might contain
\begin{itemize}
\item title of the SIP,
\item hash of the SIP text,
\item author(s),
\item update justification,
\item update scope,
\item update constraints, e.g.:
  \begin{itemize}
  \item dependencies,
  \item conflicts w.r.t. other update proposals,
  \item prerequisites, etc.
  \end{itemize}
\item duration of the SIP voting period,
\item priority, etc.
\end{itemize}

Update proposals in this phase are recorded as a text document.
% TODO: do we need to mention the P2P storage system that is assumed? Why? Is it
% relevant for the protocol described in this document?
This design does not constrain where the SIP text is stored. A SIP that is
unavailable or whose hash does not match the one submitted on the chain can
simply be rejected by the community.

Update constraints, determine the feasibility of a system update.

The SIP is submitted to the blockchain by means of a fee-supported transaction.
Any stakeholder can submit an SIP, thereby proposing a system update.

The SIP submission takes place under a commit-reveal scheme, to ensure that the
ownership of the proposals is preserved.
%
% TODO: we should describe this commit reveal scheme
%

One the SIP is revealed, stakeholders can access all the details of the SIP and
a voting period starts. Note that stakeholders not only vote for the SIP, but
also for other characteristics of the update such as:
\begin{itemize}
\item type of change,
\item priority,
\item criticality, etc.
\end{itemize}
These characteristics are described in the SIP's metadata.

In the case that the evaluation of an SIP requires deep technical knowledge,
stakeholders can make use of a delegation mechanism which is described in
Section~\ref{sec:delegation-mechanics}.

\subsection{Implementation}
\label{sec:implementation}

During the implementation phase of an update, an SIP is implemented. This is an
off-chain process. Not all SIPs require an implementation. Examples of such SIP
include protocol-parameters updates, or fund transfers.

\subsection{Approval}
\label{sec:approval}

Once the implementation of an SIP is ready, the developer creates a bundle that
consists of:
\begin{itemize}
\item source code,
\item metadata,
\item and optionally binaries.
\end{itemize}
This bundle must be uploaded to a repository (decentralized or otherwise), and a
content-based hash must be produced to uniquely identify it. This hash, together
with other metadata is called the \emph{update proposal} (UP)
submitted to the blockckain.

This UP must be submitted to the blockchain for approval by the stakeholders to
move forward in the update process. Submission of the UP takes place using the
commit-reveal scheme described in Section~\ref{sec:ideation}.

% TODO: do we say anything about the not being a centrally owned code
% repository? This seems to be irrelevant to the protocol described here.

All approved UPs are stored in the blockchain. This enables the developer to
find the appropriate source code versions that will be updated (probably the
latest) using the link provided in the UP's metadata.

The review of the code requires advanced technical skills. For this reason we
expect the majority of stakeholders to make use of the delegation mechanism
describe in Section~\ref{sec:delegation-mechanics}.

\subsection{Activation}
\label{sec:activation}

In the activation phase the protocol updates are \emph{activated}. Protocol
updates enter this phase after they are approved by the stakeholders.

The activation phase features a \emph{synchronization} period for signaled
updates. During this period the node operators can perform the manual steps
necessary to update the software. Once the software is installed, the update
does not take place right away, since the nodes need to synchronize to avoid
chain splits. The new protocol version remains in a latent state until
activation takes place.

In a signaled update, the nodes use the synchronization period to signal other
nodes their readiness to run the new protocol version.

One popular method for signaling is to include the new version of the software
in the blocks the node issue. This signals the fact that they are ready to run
the new version. This is the approach taken by Bitcoin~\cite{bitcoin}. A
drawback of this method is that it restricts signaling only to \emph{block
  producing nodes}, thereby excluding other type of such as \emph{full-node
  clients}, \emph{light-node clients}, etc. A major drawback is that the
activation of changes is delayed by the block creation process which is slow.

An alternative signaling method that does not suffer from the drawbacks above is
to signal upgrade readiness by means of fee-based transactions. Such
transactions are bounded to stakeholder keys and therefore bound to specific
stake.
%
As a result we only have to wait for these messages to be stable on the
blockchain.

Furthermore, we could even use a separate consensus protocol, just for the
purpose to agree on the binary value carried by these messages (Ready | Not
Ready) (i.e., a binary Byzantine Agreement problem). The parties taking part in
this new protocol would be any node (client, or maintainer) that actively
participates in the underlying consensus protocol and thus needs to synchronize
with its peers with respect to the activation of some change. The main
assumptions (network, setup, computation as in Garay et al. \cite{sok}) of this
consensus protocol, naturally will be identical to the assumptions of the
underlying consensus protocol and therefore the
\emph{resiliency}\footnote{According to Garay et. al. in \cite{sok}, the
  resiliency is the fraction $(t/n)$ of misbehaving parties a protocol can
  tolerate, where $t$ are the number of adversaries and n are the total number
  of parties. In our case, we can assume that $t$ is the total adversary stake
  and $n$ is the total stake.} of the protocol will also be the same.

All in all, by departing from the block signaling solution, we can distinguish
between the readiness of different types of nodes and achieve a faster
calculation of the adoption threshold. Of course, the downsides in this case are
the added complexity and the extra fee that has to be paid for each activation
signal.

After a sufficient portion of the block producing nodes communicate that they
are able to run the new version the switch to the new protocol can take place.
This not happen right after such majority is reached, but instead the switch to
the new protocol version takes place at a predefined time in the future, most
likely the beginning of a new epoch.

Non-signaled protocol updates do not require synchronization between nodes, but
their activation also takes place at a predefined time in the future.

% This seems like the right place to cite the Esorics paper. When we talk about
% the "enactment" process, we should mention what are the possible solutions. We
% should also mention the hard-fork combinator.

\subsection{Performance analysis}
\label{sec:performance-analysis}
% FROM performance considerations

\subsubsection{Impact on transaction throughput}
\label{sec:impact-trans-thro}

\subsubsection{Impact on processing time}
\label{sec:impact-proc-time}

\subsubsection{Impact on memory consumption}
\label{sec:impact-memory-cons}

\section{Satisfying the requirements}
\label{sec:satisfy-requ}

% How does the different aspects of the design satisfies the requirements.

\subsection{Open}
\label{sec:sat-open}

This design does not address the definition of minimal requirements for proposal
submissions that will prevent spam attacks.

This design addresses the requirement that any participant that can submit a
common transaction should be able to vote on update proposals, by
defining a new \emph{vote} transaction type.

\subsection{Democratic}
\label{sec:sat-decentr-decis-making}

This design addresses the requirements that the community can vote on updates,
by replacing central authorities with an on-chain voting mechanism in which
participants either:
\begin{itemize}
\item vote directly by submitting a vote to the blockchain in the same way they
  submit regular transactions, or
\item delegate their vote to experts who will vote on their behalf.
\end{itemize}

\subsection{Protocol driven}
\label{sec:sat-protocol-driven}

The update mechanism here described can be run as part of the ledger rules of a
blockchain.

\subsection{Transparent and auditable}
\label{sec:sat-transp-audit}

By making the update proposals and votes part of the transactions that are
included in blocks, we ensure that the system updates history is stored in the
immutable ledger that is the blockchain.

\subsection{Secure}
\label{sec:sat-secure}

% TODO: is delegation to experts part of the security of the protocol?
% Delegation to experts:
%
% - makes participation more likely (although this depends on the experts' incentives)
%
% - put's important decisions in the hands of the people that have the technical
%   knowledge
%

\subsection{Performant and scalable}
\label{sec:sat-performant-scalable}

Our back-of-the envelope calculations showed that the update protocol has an
impact on the system throughput that is linear on the number of participants.
These numbers were confirmed by the measurements we took after running several
experiments on a testnet.

Our asymptotic complexity analysis and micro-benchmarks showed that the impact
on system's performance is also linear on the number of participants.

\subsection{Metadata-driven}
\label{sec:sat-metadata-driven}

We have define an update protocol where the submitter of a proposal can specify
(when applicable):
\begin{itemize}
\item its priority,
\item its dependency,
\item the duration of its voting period,
\item the duration of its deployment window.
\item the threshold per-proposal via the $\gamma$ parameter.
\end{itemize}

\subsection{Consistent}
\label{sec:sat-cons-update-logic}

The activation protocol in Section~\ref{sec:activation} defines a queuing
mechanism that ensures that proposals are activated in the order prescribed by
their priorities. Furthermore, this queuing mechanism ensures a candidate
for activation always supersedes the current protocol version.

This protocol also handles conflicts in which multiple proposals try to
supersede the same version, and defines an emergency mechanism for canceling
proposals when they are in the activation phase.

The voting period of a proposal submitted to either the ideation or approval
phases is taken from the proposal's metadata.
% TODO: we should make sure that we cap this voting period, and mention this
% exception here.
Similarly, the deployment window, in the case of consensus-impacting updates, is
also determined by the proposal's metadata.

\section{Implementation}
\label{sec:implementation-1}

% Mention that we have an implementation of the concepts presented in this
% document, without giving much details about it. The interested reader can look
% at the code (and maybe we'll have time to document this design).
Parts of the design described in this document was implemented and integrated to Cardano,
in a separate branch.

% Which parts were not implemented?
Expert pools and delegation was not implemented in the prototype. These aspects
are orthogonal to the update logic that was implemented in the prototype, and as
such, they can be added later.

As a result of the implementation of the prototype:
\begin{itemize}
\item We developed a property testing framework, which improves upon previous
  work by IOHK.
\item We made the ledger layer of Cadano parametric on the update logic. This
  was merged onto master, and as a result it is now easier to swap Cardano's
  update mechanism.
\item We ran benchmarks on a testnet. The results we obtained from these
  benchmarks confirmed that usage is linear on the number of participants as
  predicted. On the other hand, we observed a quadratic increase in the
  transaction latency. In our benchmarks we used a very short voting period of
  10 minutes, and we reproduced the worst-case and unrealistic assumption that
  every participant would vote at the same time. Nevertheless, further analysis
  is needed for a production ready update protocol to determine if safeguard
  measures against high transaction latency are required.
\end{itemize}

% The interested reader can check: deliverables, source code. Maybe an
% implementation report.
The reader interested in the design and implementation of the prototype can
check the PRIViLEDGE deliverables~\cite{priviledge_d11, priviledge_d12,
  priviledge_d41}, as well as the implementation documentation and source
code~\cite{dsu-repo2021}.

\section{Related work}
\label{sec:related-work}

\section{Problems not addressed}
\label{sec:probl-not-addr}

% Which problems were not addressed? Why not?

% How can the prototype accommodate potential solutions to these problems.
          % - Using different voters set or voting weights.
          % - Incentives (it's an orthogonal, we see in principle nothing to
          %   accommodate).
          % - Spam protection: have a set of allowed submitters that is checked
          %   upon proposal submission (could be at commit time or at reveal
          %   time).

        % - How this prototype can accommodate a restriction in scope:
        %   - Having less phases.

        %   - Having a committee / set of genesis keys.

\section{Conclusions}
\label{sec:conclusions}

\bibliographystyle{acm}
\bibliography{references}

\end{document}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
